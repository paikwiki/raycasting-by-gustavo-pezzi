<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="p5.min.js"></script>
    <title>Raycasting Basics with Javascript</title>
    <style>
        body,html{margin:0;padding:0;background:#f5fffa;color:#222}header{text-align:center}header a,header a:visited{color:#4169e1}canvas{display:block;margin:0 auto;border-style:solid;border-width:4px;border-color:#222;background:#444}
    </style>
</head>
<body>
<header>
    <h1>Raycasting Basics with Javascript</h1>
    <p>Use the arrow keys to look around.</p>
    <p>This source code is based on "<a href="https://courses.pikuma.com/courses/raycasting" target="_blank">Raycasting Basics with Javascript(by Gustavo Pezzi)</a>."</p>
</header>
<script>
const TILE_SIZE=48,MAP_NUM_ROWS=11,MAP_NUM_COLS=15,WINDOW_WIDTH=MAP_NUM_COLS*TILE_SIZE,WINDOW_HEIGHT=MAP_NUM_ROWS*TILE_SIZE,FOV_ANGLE=Math.PI/180*60,WALL_STRIP_WIDTH=5,NUM_RAYS=WINDOW_WIDTH/WALL_STRIP_WIDTH,MINIMAP_SCALE_FACTOR=.2;class Map{constructor(){this.grid=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1],[1,0,0,1,0,1,0,0,0,0,0,0,1,0,1],[1,0,1,1,1,0,0,0,0,0,1,0,1,0,1],[1,0,0,0,0,0,0,0,0,0,1,0,1,0,1],[1,0,0,0,0,0,0,0,1,1,1,1,1,0,1],[1,1,1,0,1,1,1,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,1,0,0,1,0,1],[1,1,1,1,1,1,0,0,0,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]]}hasWallAt(t,a){if(t<0||t>WINDOW_WIDTH||a<0||a>WINDOW_HEIGHT)return!0;var i=Math.floor(t/TILE_SIZE),e=Math.floor(a/TILE_SIZE);return 0!=this.grid[e][i]}render(){for(var t=0;t<MAP_NUM_ROWS;t++)for(var a=0;a<MAP_NUM_COLS;a++){var i=a*TILE_SIZE,e=t*TILE_SIZE,r=1==this.grid[t][a]?"#333":"#fff";stroke("#333"),fill(r),rect(MINIMAP_SCALE_FACTOR*i,MINIMAP_SCALE_FACTOR*e,MINIMAP_SCALE_FACTOR*TILE_SIZE,MINIMAP_SCALE_FACTOR*TILE_SIZE)}}}class Player{constructor(){this.x=WINDOW_WIDTH/2,this.y=TILE_SIZE+TILE_SIZE/2,this.radius=3,this.turnDirection=0,this.walkDirection=0,this.rotationAngle=Math.PI/2,this.moveSpeed=2,this.rotationSpeed=Math.PI/180*2}update(){this.rotationAngle+=this.turnDirection*this.rotationSpeed;var t=this.walkDirection*this.moveSpeed,a=this.x+Math.cos(this.rotationAngle)*t,i=this.y+Math.sin(this.rotationAngle)*t;grid.hasWallAt(a,i)||(this.x=a,this.y=i)}render(){noStroke(),fill("blue"),circle(MINIMAP_SCALE_FACTOR*this.x,MINIMAP_SCALE_FACTOR*this.y,MINIMAP_SCALE_FACTOR*this.radius),stroke("blue"),line(MINIMAP_SCALE_FACTOR*this.x,MINIMAP_SCALE_FACTOR*this.y,MINIMAP_SCALE_FACTOR*(this.x+30*Math.cos(this.rotationAngle)),MINIMAP_SCALE_FACTOR*(this.y+30*Math.sin(this.rotationAngle)))}}class Ray{constructor(t){this.rayAngle=normalizeAngle(t),this.wallHitX=0,this.wallHitY=0,this.distance=0,this.wasHitVertical=!1,this.isRayFacingDown=this.rayAngle>0&&this.rayAngle<Math.PI,this.isRayFacingUp=!this.isRayFacingDown,this.isRayFacingRight=this.rayAngle<.5*Math.PI||this.rayAngle>1.5*Math.PI,this.isRayFacingLeft=!this.isRayFacingRight}cast(){var t,a,i,e,r=!1,s=0,n=0;a=Math.floor(player.y/TILE_SIZE)*TILE_SIZE,a+=this.isRayFacingDown?TILE_SIZE:0,t=player.x+(a-player.y)/Math.tan(this.rayAngle),e=TILE_SIZE,e*=this.isRayFacingUp?-1:1,i=TILE_SIZE/Math.tan(this.rayAngle),i*=this.isRayFacingLeft&&i>0?-1:1,i*=this.isRayFacingRight&&i<0?-1:1;for(var I=t,l=a;I>=0&&I<=WINDOW_WIDTH&&l>0&&l<=WINDOW_HEIGHT;){if(grid.hasWallAt(I,l-(this.isRayFacingUp?1:0))){r=!0,s=I,n=l;break}I+=i,l+=e}var _=!1,A=0,h=0;t=Math.floor(player.x/TILE_SIZE)*TILE_SIZE,t+=this.isRayFacingRight?TILE_SIZE:0,a=player.y+(t-player.x)*Math.tan(this.rayAngle),i=TILE_SIZE,i*=this.isRayFacingLeft?-1:1,e=TILE_SIZE*Math.tan(this.rayAngle),e*=this.isRayFacingUp&&e>0?-1:1,e*=this.isRayFacingDown&&e<0?-1:1;for(var o=t,y=a;o>=0&&o<=WINDOW_WIDTH&&y>0&&y<=WINDOW_HEIGHT;){if(grid.hasWallAt(o-(this.isRayFacingLeft?1:0),y)){_=!0,A=o,h=y;break}o+=i,y+=e}var M=r?distanceBetweenPoints(player.x,player.y,s,n):Number.MAX_VALUE,E=_?distanceBetweenPoints(player.x,player.y,A,h):Number.MAX_VALUE;E<M?(this.wallHitX=A,this.wallHitY=h,this.distance=E,this.wasHitVertical=!0):(this.wallHitX=s,this.wallHitY=n,this.distance=M)}render(){stroke("rgba(255, 0, 0, 0.3)"),line(MINIMAP_SCALE_FACTOR*player.x,MINIMAP_SCALE_FACTOR*player.y,MINIMAP_SCALE_FACTOR*this.wallHitX,MINIMAP_SCALE_FACTOR*this.wallHitY)}}var grid=new Map,player=new Player,rays=[];function keyPressed(){keyCode==UP_ARROW?player.walkDirection=1:keyCode==DOWN_ARROW?player.walkDirection=-1:keyCode==RIGHT_ARROW?player.turnDirection=1:keyCode==LEFT_ARROW&&(player.turnDirection=-1)}function keyReleased(){keyCode==UP_ARROW?player.walkDirection=0:keyCode==DOWN_ARROW?player.walkDirection=0:keyCode==RIGHT_ARROW?player.turnDirection=0:keyCode==LEFT_ARROW&&(player.turnDirection=0)}function castAllRays(){var t=player.rotationAngle-FOV_ANGLE/2;rays=[];for(var a=0;a<NUM_RAYS;a++){var i=new Ray(t);i.cast(),rays.push(i),t+=FOV_ANGLE/NUM_RAYS}}function render3DProjectedWalls(){for(var t=0;t<NUM_RAYS;t++){var a=rays[t],i=a.distance*Math.cos(a.rayAngle-player.rotationAngle),e=WINDOW_WIDTH/2/Math.tan(FOV_ANGLE/2),r=TILE_SIZE/i*e,s=180/i,n=a.wasHitVertical?255:223;fill(`rgba(${n}, ${n}, ${n}, ${s})`),noStroke(),rect(t*WALL_STRIP_WIDTH,WINDOW_HEIGHT/2-r/2,WALL_STRIP_WIDTH,r)}}function normalizeAngle(t){return(t%=2*Math.PI)<0&&(t=2*Math.PI+t),t}function distanceBetweenPoints(t,a,i,e){return Math.sqrt((i-t)*(i-t)+(e-a)*(e-a))}function setup(){createCanvas(WINDOW_WIDTH,WINDOW_HEIGHT)}function update(){player.update(),castAllRays()}function draw(){for(ray of(clear("#212121"),update(),render3DProjectedWalls(),grid.render(),rays))ray.render();player.render()}
</script>
</body>
</html>
